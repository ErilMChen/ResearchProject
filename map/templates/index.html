{% load static %}
<!DOCTYPE html>
<html lang="en"></html>
<head>
    <title>Home</title>
    <script>
        var map;
        var directionsService;
        var directionsRenderer;
        // Map initialization
        function initMap() {
            var mapProp = {
                // map coordinates
                center: new google.maps.LatLng(53.3472, -6.2592),
                zoom: 12,
            };
            // google map initialization
            map = new google.maps.Map(document.getElementById("map"), mapProp);
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();

            // time date option initialization
            initDateTime();
            // Bus stop option initialization
            initBusStops();
            // bing button with function
            iniEventListener();
            // load plan from local storage
            loadPlanFromJson();
        }
    </script>

    <script>
        // two arrays use for input validation (not done yet)
        var dateArray = new Array();
        var timeArray = new Array();
        function initDateTime(){
            var myDate = new Date();
            var date = document.getElementById('date');
            for(var i =0; i <5; i++){
                // Create dates for the next 5 days
                var newDate=new Date(myDate.getTime()+i*1000*60*60*24);
                var str =newDate.getDate() + "/" + (newDate.getMonth() + 1) + "/" +(newDate.getYear() + 1900);
                var dateOption=document.createElement("option");
                dateOption.setAttribute("value", str);
                date.appendChild(dateOption);
                dateArray.push(str);
            }
            // create time for the 24 hours
            var time = document.getElementById('time');
            for(var j= 1; j <= 24; j++){
                var str = j + ":00"
                var timeOption = document.createElement("option");
                timeOption.setAttribute("value", str);
                time.appendChild(timeOption);
                timeArray.push(str);
            }
        }
    </script>

    <script>
        var busStopsArray = new Array();
        function initBusStops(){
            // read bus station data from django server
            fetch("busstation", {
                method:'GET'}).then(function(response) {
                    return response.json();
                })
            .then(function(busData) {
                // create bus station option 
                var startStop = document.getElementById('start_stop');
                var endStop = document.getElementById('end_stop');
                var str= "";
                var count = 0;
                busData.forEach(element => {
                    // create strat option from each bus stop
                    var startOption=document.createElement("option")
                    startOption.setAttribute("value",element.stop_name);
                    startStop.appendChild(startOption);
                    // create end option from each bus stop
                    var endOption=document.createElement("option")
                    endOption.setAttribute("value",element.stop_name);
                    endStop.appendChild(endOption);
                    // array fro input validation (not done yet)
                    busStopsArray.push(element.stop_name);
                });
            });
        }
    </script>

    <script>
        function iniEventListener(){
            // bind button with function
            var submit = document.getElementById("submit").addEventListener("click", markBusRoute);
            var save = document.getElementById("save").addEventListener("click", savePlanToJson);
            var plan = document.getElementById("plan").addEventListener("click", showPlanPage);
            var search = document.getElementById("search").addEventListener("click", showSearchPage);
            var weather = document.getElementById("weather").addEventListener("click", showWeatherWidget);
            var add_stop1 = document.getElementById("add_stop1").addEventListener("click", function(){ addStop("add_stop1");}); 
            var add_stop2 = document.getElementById("add_stop2").addEventListener("click", function(){ addStop("add_stop2");}); 
        }
    </script>

    <script>
        function addStop(element){
            if(element == "add_stop1")
                var stop_name = document.forms["bus_stop"]["start_stop"].value;
            else if (element == "add_stop2")
                var stop_name = document.forms["bus_stop"]["end_stop"].value;
            let url = 'add/' + '?stop_name=' + stop_name;
            fetch(url, {
                method:'GET'}).then(function(response) {
                    // read data from django server and prase to json
                    console.log("add stop OK")
            });
        }
    </script>

    <script>
        // save route
        function saveBusRoute(){
            // read data from form
            var start = document.forms["bus_stop"]["start_stop"].value;
            var end = document.forms["bus_stop"]["end_stop"].value;
            var date = document.forms["bus_stop"]["date"].value;
            var time = document.forms["bus_stop"]["time"].value;
            // creat url which use fro send request to django server
            let url = 'route/'+'?start_stop='+start+'&end_stop='+end +'&date='+date +'&time='+time;
            fetch(url, {
                method:'GET'}).then(function(response) {
                    // read data from django server and prase to json
                    return response.json();
                });
            savePlanToJson();
        }
        // save data to local storage
        function savePlanToJson(){
            // read data from form
            var start = document.forms["bus_stop"]["start_stop"].value;
            var end = document.forms["bus_stop"]["end_stop"].value;
            var date = document.forms["bus_stop"]["date"].value;
            var time = document.forms["bus_stop"]["time"].value;
            // creat url which use fro send request to django server
            // the url will be the key used in local storage
            let url = 'route/'+'?start_stop='+start+'&end_stop='+end +'&date='+date +'&time='+time;
            var locations = {
                startStop :  start,
                endStop : end,
                date : date,
                time : time
            }
            str = JSON.stringify(locations);
            // key is url, value is location information
            // save to local storage
            localStorage.setItem(url,str);
        }
    </script>

    <script>
        // read data from local storage
        function loadPlanFromJson(){
            var target = document.getElementById("plan_container");
            var key;
            for(var i=localStorage.length - 1 ; i >=0; i--){
                (function(i){
                // traverse each key
                var url = localStorage.key(i);
                // get value by using key
                var str=localStorage.getItem(url); 
                var locations=JSON.parse(str); 

                // create plan buttons 
                var container = document.createElement("button");
                // bind button with function
                container.addEventListener("click", function(){ showPlan(url);}); 
                // write route infromation on buuton       
                writeLine("start stop: "+ locations.startStop, container);
                writeLine("end stop: "+ locations.endStop, container);
                writeLine("date: "+ locations.date, container);
                writeLine("time: "+ locations.time, container);
                target.appendChild(container);   

                // create delete button
                var deleteButton = document.createElement("button");
                // bind button with function
                deleteButton.addEventListener("click", function(){ deletePlan(url);});
                writeLine("DELETE", deleteButton);
                target.appendChild(deleteButton);
                }(i));
            }
        }

        function deletePlan(url){
            // remove item from local storage
            localStorage.removeItem(url);
            // clean plan pannel and reload
            document.getElementById("plan_container").innerHTML=""
            document.getElementById("plan_detail_container").innerHTML=""
            loadPlanFromJson();
            showPlanPage();
        }
    </script>

    <script>
        // show plan route detail
        function showPlan(url){
            // use the key of every local storage item as url
            // send request to django server
            fetch(url, {
                method:'GET'}).then(function(response) {
                    return response.json();
                })
            .then(function(routeDate){
                //map clear
                var mapProp = {
                    center: new google.maps.LatLng(53.3472, -6.2592),
                    zoom: 12,
                };
                map = new google.maps.Map(document.getElementById("map"), mapProp);
                
                // use google api to set route on map
                directionsRenderer.setMap(map);
                directionsRenderer.setPanel(document.getElementById("sidebar"));
                // set strat posiotion and end posiotion
                var start_position = new google.maps.LatLng(routeDate[0].stop_lat, routeDate[0].stop_long);
                var end_position = new google.maps.LatLng(routeDate[1].stop_lat, routeDate[1].stop_long);
                var request = {
                    origin: start_position,
                    destination: end_position,
                    travelMode: google.maps.TravelMode["TRANSIT"],
                    provideRouteAlternatives :false,
                    transitOptions: {
                        modes: ['BUS'],
                    },

                };
                // send request to google map server
                directionsService.route(request, function(response, status) {
                    if (status == 'OK') {
                        //draw route on map (google api)
                        directionsRenderer.setDirections(response);
                        //show route detail
                        showRoutedetail(response, "plan_detail_container")
                    }
                });
            });
        }
    </script>

    <script>
        // Submit the starting and ending stations and return to the navigation route
        function markBusRoute( ){
            // read user input from form
            var start = document.forms["bus_stop"]["start_stop"].value;
            var end = document.forms["bus_stop"]["end_stop"].value;
            var date = document.forms["bus_stop"]["date"].value;
            var time = document.forms["bus_stop"]["time"].value;
            // create url
            let url = 'route/'+'?start_stop='+start+'&end_stop='+end +'&date='+date +'&time='+time;
            fetch(url, {
                // send request to django server
                method:'GET'}).then(function(response) {
                    return response.json();
                })
            .then(function(routeDate){
                console.log(routeDate);
                //map clear
                var mapProp = {
                    center: new google.maps.LatLng(53.3472, -6.2592),
                    zoom: 12,
                };
                map = new google.maps.Map(document.getElementById("map"), mapProp);
                // use google api to set route on map
                directionsRenderer.setMap(map);
                directionsRenderer.setPanel(document.getElementById("sidebar"));
                // set strat posiotion and end posiotion
                var start_position = new google.maps.LatLng(routeDate[0].stop_lat, routeDate[0].stop_long);
                var end_position = new google.maps.LatLng(routeDate[1].stop_lat, routeDate[1].stop_long);
                var request = {
                    origin: start_position,
                    destination: end_position,
                    travelMode: google.maps.TravelMode["TRANSIT"],
                    provideRouteAlternatives :false,
                    transitOptions: {
                        modes: ['BUS'],
                    },

                };
                directionsService.route(request, function(response, status) {
                    if (status == 'OK') {
                        //draw route on map (google api)
                        directionsRenderer.setDirections(response);
                        //show route detail
                        showRoutedetail(response, "detail_container")
                    }
                });
            });
        }
    </script>

    <script>
        // show route detail infromation
        function showRoutedetail(response, element){
            // extract data from google response
            var myRoute = response.routes[0].legs[0];
            var locations = new Array();
            var total_distance = 0, total_duration = 0;
            // var jsonData = {};
            for (var i = 0; i < myRoute.steps.length; i++) {
                if(myRoute.steps[i].travel_mode == "TRANSIT")
                {
                    // route detail from google server
                    var location={
                        startStop : myRoute.steps[i].transit.departure_stop.name,
                        endStop : myRoute.steps[i].transit.arrival_stop.name,
                        line : myRoute.steps[i].transit.line.short_name,
                        distance : myRoute.steps[i].distance.text,
                        duration : myRoute.steps[i].duration.text,
                    }
                    total_duration += Math.round(myRoute.steps[i].duration.value/60);
                    total_distance += Math.round(myRoute.steps[i].distance.value/1000);
                    locations.push(location)
                }
            }

            // write infrom mation on certain element
            var target = document.getElementById(element);
            target.innerHTML = "";
            var text ="Total distance: " + total_distance + " kilometres\n" + "Total duration: " + total_duration + " minnuites";
            writeLine(text, target);
            for (var i = 0; i< locations.length; i++){
                writeLine("The "+ (i+1) + " leg of the journey", target)
                writeLine("departure stop: "+locations[i].startStop, target)
                writeLine("arrival stop: "+ locations[i].endStop, target)
                writeLine("bus line: "+ locations[i].line, target)
                writeLine("distance: "+ locations[i].distance, target)
                writeLine("duration: "+ locations[i].duration, target)
            }
        }
    </script>

    <script>
        // when press plan button, show plan page
        function showPlanPage(){
            var plan_container = document.getElementById("plan_container");
            var plan_detail_container = document.getElementById("plan_detail_container");
            var detail_container = document.getElementById("detail_container");
            var search_form = document.getElementById("search_form");
            detail_container.style.display="none";
            search_form.style.display="none";
            plan_container.style.display="block";
            plan_detail_container.style.display="block";
            // clear plan page then loadPlanFromJson();
            document.getElementById("plan_container").innerHTML=""
            loadPlanFromJson();
            
        }
        // when press search button, show search page
        function showSearchPage(){
            var plan_container = document.getElementById("plan_container");
            var plan_detail_container = document.getElementById("plan_detail_container");
            var detail_container = document.getElementById("detail_container");
            var search_form = document.getElementById("search_form");
            detail_container.style.display="block";
            search_form.style.display="block";
            plan_container.style.display="none";
            plan_detail_container.style.display="none";
        }
        // when press weather button, show weather widget
        function showWeatherWidget(){
            var weather_detail_container = document.getElementById("weather_detail_container");
            if (weather_detail_container.style.display =="block")
                weather_detail_container.style.display ="none";
            else    
                weather_detail_container.style.display ="block";
        }
    </script>

    <script>
        // write text on certain element
        function writeLine(text ,target){
            var container = document.createElement("div");
            var node = document.createTextNode(text);
            container.appendChild(node);
            target.appendChild(container);
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHY3W-xvNE-42BipvMY_-lu4aKdnB5xn4&callback=initMap&libraries=&v=weekly" async>
    </script>

    <script>window.myWidgetParam ? window.myWidgetParam : window.myWidgetParam = [];  window.myWidgetParam.push({id: 9,cityid: '2964574',appid: '86e6d9e6dddfc8dccd6899f2454e98c2',units: 'metric',containerid: 'openweathermap-widget-9',  });  (function() {var script = document.createElement('script');script.async = true;script.charset = "utf-8";script.src = "//openweathermap.org/themes/openweathermap/assets/vendor/owm/js/weather-widget-generator.js";var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(script, s);  })();</script>
</head>

<body>


    <div id="floating_window">
        <input id="search" type="button" value="search route" style="height: 3em; margin: 0.5em;">
        <input id="plan" type="button" value="my plan" style="height: 3em; margin: 0.5em;">
        <input id="weather" type="button" value="weather" style="height: 3em; margin: 0.5em;">
        <div style="border-style: solid; background-color: lightseagreen;">
            <form action="route/" name = "bus_stop" id="search_form">
                <input list="start_stop" name="start_stop" placeholder="From" />
                <datalist id="start_stop"></datalist>
                <input id="add_stop1" type="button" style="height: 1em; background-color: crimson;">
                
                <input list="end_stop" name="end_stop" placeholder="To" />
                <datalist id="end_stop"></datalist>
                <input id="add_stop2" type="button" style="height: 1em; background-color: crimson;">

                <input list="date" name="date" placeholder="date"/>
                <datalist id="date"></datalist>
                
                <input list="time" name="time" placeholder="time"/>
                <datalist id="time"></datalist>        
                
                <input id="submit" type="button" value="submit" style="height: 3em; margin: 0.5em;">
                <input id="save" type="button" value="save" style="height: 3em; margin: 0.5em;">
            </form>

            <div id="detail_container" ></div>
            <div id="plan_container" style="display: none;"> </div>
            <div id="plan_detail_container" style="display: none;"> </div>
        </div>
    </div>

    <div id="weather_detail_container" style="display: none;">
        <div id="openweathermap-widget-9"></div>
    </div>

    <div id="container">
        <div id="map" style="width:1020px;height:680px;"></div>
        <div id="sidebar"></div>
    </div>
{% block title %}Create an Account {% endblock %}
{% load crispy_forms_tags %}

{% block body %}

<form method="POST" action= "/users/" class="form-group">
    {% csrf_token %}
    {{ form1|crispy }}
        <button type="submit" class="'btn btn-success">Register</button>
</form>

<form action="/login/" method="POST">
        {% csrf_token %}
        {{ form2|crispy }}
     <button type="submit" name="" class="'btn btn-success">Login</button>
    </form>

{% endblock %}


</body>

</html>